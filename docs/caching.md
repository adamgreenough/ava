# Caching

Ava uses two distinct caching layers to deliver fast page loads without a database.

## Overview

| Layer | What it stores | Purpose |
|-------|----------------|---------|
| **Content Index** | Metadata, routes, taxonomy data | Avoid parsing Markdown on every request |
| **Page Cache** | Rendered HTML pages | Serve pages instantly without rendering |

The **Content Index** is the foundation—a binary snapshot of your content structure. The **Page Cache** stores the final HTML output for instant serving.

---

## Content Index

When you add or edit content, Ava doesn't read Markdown files on every request. Instead, it builds an index of all content metadata and stores it in `storage/cache/`.

### Index Files

| File | Contents |
|------|----------|
| `content_index.bin` | All content items indexed by type, slug, and ID |
| `tax_index.bin` | Taxonomy terms with item counts |
| `routes.bin` | Compiled URL → content mappings |
| `fingerprint.json` | Hash of content files for change detection |

### Configuration

Set the rebuild mode in `app/config/ava.php`:

\`\`\`php
'content_index' => [
    'mode' => 'auto',
],
\`\`\`

| Mode | Behavior | Best for |
|------|----------|----------|
| `auto` | Rebuilds when content files change | Development, small sites |
| `never` | Only rebuilds via `./ava rebuild` | Production, CI/CD |
| `always` | Rebuilds on every request | Debugging only |

**Recommendation:** Use `auto` during development, switch to `never` for production.

### Binary Serialization

Index files use binary serialization for fast loading:

- **igbinary** (if installed): ~15x faster, ~90% smaller
- **PHP serialize** (fallback): Works everywhere

Files include a format marker (`IG:` or `SZ:`) for safe environment switching. Run `./ava rebuild` after changing PHP environments.

### Manual Rebuild

\`\`\`bash
./ava rebuild
\`\`\`

Rebuilds the content index and clears the page cache. Takes ~2-3 seconds for 10,000 items.

---

## Page Cache

The page cache stores fully-rendered HTML. When a visitor requests a cached page, Ava serves the static HTML directly—no template rendering, no Markdown parsing.

### How It Works

1. **First request**: Page is rendered normally (~30-50ms)
2. **Cache write**: HTML saved to `storage/cache/pages/`
3. **Subsequent requests**: Cached HTML served (~0.1ms)

This is **on-demand** caching—pages are cached after their first visit.

### Configuration

\`\`\`php
'page_cache' => [
    'enabled' => true,
    'ttl' => null,
    'exclude' => [
        '/api/*',
        '/preview/*',
    ],
],
\`\`\`

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `enabled` | bool | `true` | Enable HTML page caching |
| `ttl` | int\|null | `null` | Lifetime in seconds. `null` = until rebuild |
| `exclude` | array | `[]` | URL patterns to never cache |

### What Gets Cached

- ✅ Single content pages (posts, pages, custom types)
- ✅ Archive pages (post lists, paginated archives)
- ✅ Taxonomy pages (categories, tags)
- ❌ Admin pages
- ❌ URLs with query parameters (except UTM)
- ❌ Logged-in admin users
- ❌ POST/PUT/DELETE requests

### Per-Page Override

Override the global setting in frontmatter:

\`\`\`yaml
---
title: My Dynamic Page
cache: false
---
\`\`\`

### Cache Invalidation

The page cache is cleared when:

- `./ava rebuild` is run
- Content changes (with `content_index.mode = 'auto'`)
- "Rebuild Now" clicked in admin
- "Flush Pages" clicked in admin

Clear manually:

\`\`\`bash
./ava pages:clear              # Clear all
./ava pages:clear /blog/*      # Clear matching pattern
\`\`\`

### HTML Comments

Every page includes a footer comment:

**Fresh render:**
\`\`\`html
<!-- Generated by Ava CMS v25.12.1 | Rendered: 2025-12-29 10:00:00 | 32ms -->
\`\`\`

**Cached page:**
\`\`\`html
<!-- Generated by Ava CMS v25.12.1 | Cached: 2025-12-29 10:00:00 -->
\`\`\`

---

## Monitoring

### CLI

\`\`\`bash
./ava status         # Shows content index and page cache status
./ava pages:stats    # Detailed page cache stats
\`\`\`

### Admin Dashboard

The dashboard shows both layers with quick actions:
- **Rebuild Now**: Rebuilds content index (clears page cache)
- **Flush Pages**: Clears page cache only

---

## Performance

Tested with 10,000 content items:

| Operation | Time |
|-----------|------|
| Content index rebuild | ~2.4s |
| Content index load | ~45ms |
| Page render (uncached) | ~70ms |
| Page serve (cached) | ~0.1ms |

Sizes:
- Content index: ~4MB (10k items with igbinary)
- Page cache: ~1-5KB per page

---

## Security

The page cache is secure by default:

| Protection | How |
|------------|-----|
| Query string XSS | URLs with \`?params\` bypass cache |
| Cache poisoning | Cache key is URL path only |
| Session leakage | Admin users bypass cache |
| POST injection | Only GET requests cached |
| Path traversal | Filenames are MD5 hashed |

---

## Troubleshooting

### Pages not being cached

1. Check if enabled: \`./ava status\`
2. Log out of admin (admin users bypass cache)
3. Check exclude patterns
4. Check for query parameters in URL

### Content changes not appearing

1. If \`mode\` is \`never\`, run \`./ava rebuild\`
2. Delete \`storage/cache/fingerprint.json\` to force rebuild
3. Run \`./ava rebuild\` to reset everything

### Empty content after PHP change

Run \`./ava rebuild\` to regenerate index files in the current format.
